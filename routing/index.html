
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://book.didcomm.org/routing/">
      
      
        <link rel="prev" href="../threading/">
      
      
        <link rel="next" href="../extensions/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.20">
    
    
      
        <title>Routing - DIDComm Book</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#routing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DIDComm Book" class="md-header__button md-logo" aria-label="DIDComm Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DIDComm Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Routing
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/decentralized-identity/didcomm-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        Overview
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../quickstart/" class="md-tabs__link">
        Quick Start
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../libraries/" class="md-tabs__link">
      Libraries
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../applications/vc_tech_vertical/" class="md-tabs__link">
        Protocols
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../threading/" class="md-tabs__link md-tabs__link--active">
        Advanced Topics
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../workinggroups/" class="md-tabs__link">
        Join
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DIDComm Book" class="md-nav__button md-logo" aria-label="DIDComm Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DIDComm Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/decentralized-identity/didcomm-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
        
          
            
          
        
          
        
          
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="..">Overview</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Overview
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../general_concepts/" class="md-nav__link">
        General Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../business_applications/" class="md-nav__link">
        Business Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../applications/" class="md-nav__link">
        Technology Verticals
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../oid4vc/" class="md-nav__link">
        OpenID4VC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scrapbook/" class="md-nav__link">
        Community Presentations
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Quick Start
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quick Start
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../basics/" class="md-nav__link">
        Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Hello World
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Hello World
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hellolibstools/" class="md-nav__link">
        Choosing libraries and tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helloencrypt/" class="md-nav__link">
        Build DIDComm messages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../helloworldpy/" class="md-nav__link">
        Helloworldpy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../startConnection/" class="md-nav__link">
        startConnection
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../libraries/" class="md-nav__link">
        Libraries
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Protocols
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Protocols
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../applications/vc_tech_vertical/" class="md-nav__link">
        DIDComm for Verifiable Credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../applications/human_communication_tech_vertical/" class="md-nav__link">
        DIDComm for Human Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../developing_protocols/" class="md-nav__link">
        Developing Protocols
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Advanced Topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Advanced Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../threading/" class="md-nav__link">
        Threading
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Routing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Routing
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    Routing
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing-requirements" class="md-nav__link">
    Routing Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-forward-message" class="md-nav__link">
    The forward message
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#two-dimensions" class="md-nav__link">
    Two Dimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mediators-and-relays" class="md-nav__link">
    Mediators and Relays
  </a>
  
    <nav class="md-nav" aria-label="Mediators and Relays">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-direct" class="md-nav__link">
    Scenario 1: direct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-a-gatekeeper" class="md-nav__link">
    Scenario 2: a gatekeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-3-transparent-indirection" class="md-nav__link">
    Scenario 3: transparent indirection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-4-more-indirection" class="md-nav__link">
    Scenario 4: more indirection
  </a>
  
    <nav class="md-nav" aria-label="Scenario 4: more indirection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-scenarios" class="md-nav__link">
    More Scenarios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-traditional-usage" class="md-nav__link">
    More Traditional Usage
  </a>
  
    <nav class="md-nav" aria-label="More Traditional Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-5-direct" class="md-nav__link">
    Scenario 5: direct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-6-herd-hosting" class="md-nav__link">
    Scenario 6: herd hosting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-7-intra-domain-dispatch" class="md-nav__link">
    Scenario 7: intra-domain dispatch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-8-double-mediation" class="md-nav__link">
    Scenario 8: double mediation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remember-routes-are-one-way-not-duplex" class="md-nav__link">
    Remember Routes are One-Way (not Duplex)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routing-protocol" class="md-nav__link">
    Routing Protocol
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        Extensions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../timeouts/" class="md-nav__link">
        Timeouts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mobileagents/" class="md-nav__link">
        Dealing with mobile agents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../problemcodes/" class="md-nav__link">
        Problem Codes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../privacy/" class="md-nav__link">
        Privacy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../didrotation/" class="md-nav__link">
        Didrotation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pfs/" class="md-nav__link">
        Pfs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mitm/" class="md-nav__link">
        Mitm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../authentication/" class="md-nav__link">
        Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../problems/" class="md-nav__link">
        Problems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../whatsnew/" class="md-nav__link">
        Whatsnew
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../migratorscript/" class="md-nav__link">
        V1 --> v2 migrator script
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Join
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Join
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../workinggroups/" class="md-nav__link">
        Working Groups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../repos/" class="md-nav__link">
        Repositories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    Routing
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing-requirements" class="md-nav__link">
    Routing Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-forward-message" class="md-nav__link">
    The forward message
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#two-dimensions" class="md-nav__link">
    Two Dimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mediators-and-relays" class="md-nav__link">
    Mediators and Relays
  </a>
  
    <nav class="md-nav" aria-label="Mediators and Relays">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-direct" class="md-nav__link">
    Scenario 1: direct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-a-gatekeeper" class="md-nav__link">
    Scenario 2: a gatekeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-3-transparent-indirection" class="md-nav__link">
    Scenario 3: transparent indirection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-4-more-indirection" class="md-nav__link">
    Scenario 4: more indirection
  </a>
  
    <nav class="md-nav" aria-label="Scenario 4: more indirection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-scenarios" class="md-nav__link">
    More Scenarios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-traditional-usage" class="md-nav__link">
    More Traditional Usage
  </a>
  
    <nav class="md-nav" aria-label="More Traditional Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-5-direct" class="md-nav__link">
    Scenario 5: direct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-6-herd-hosting" class="md-nav__link">
    Scenario 6: herd hosting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-7-intra-domain-dispatch" class="md-nav__link">
    Scenario 7: intra-domain dispatch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-8-double-mediation" class="md-nav__link">
    Scenario 8: double mediation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remember-routes-are-one-way-not-duplex" class="md-nav__link">
    Remember Routes are One-Way (not Duplex)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routing-protocol" class="md-nav__link">
    Routing Protocol
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Routing</h1>

<h2 id="routing">Routing<a class="headerlink" href="#routing" title="Permanent link">&para;</a></h2>
<p><strong>Routing</strong> is the process of managing the delivery of messages from sender to recipient, possibly adapting the packaging and transfer to intermediate nodes. A <strong>route</strong> is a map or plan that specifies enough to achieve delivery in at least one direction; it may omit uninteresting details.</p>
<p>A <strong>sender</strong> emits a message hoping that a <strong>recipient</strong> eventually receives it. As a message moves toward the recipient, we say it is moving <strong>destward</strong>; the opposite direction is <strong>sourceward</strong>. Note that sender and recipient flip if a request-like message is followed by a response-like message in the opposite direction; the context that defines a sender is a single message, not a paired interaction. (DIDComm supports request-response but does not require it.)</p>
<p>We tend to conceive of senders and recipients as simple &mdash; "Alice" and "Bob" sound like unitary individuals. This can be a useful simplification. However, it's important to remember that it may hide important detail; if Bob uses a laptop, a mobile device, and a cloud service to receive messages, and if each of them follows the cryptographic best practice of not sharing keys, then it is impossible to ignore this complexity in some parts of routing design. We call the set of things that Bob controls his <strong>sovereign domain</strong> (or <strong>domain</strong> for short). Note that this usage is notably different from the meaning of "domain" in DNS and many web contexts. We also use the loose cover term <strong>agent</strong> to refer to individual devices or pieces of software inside a given domain. The boundary of a domain is an important construct for trust analysis and for routing. We will explore this in greater detail below.</p>
<h3 id="routing-requirements">Routing Requirements<a class="headerlink" href="#routing-requirements" title="Permanent link">&para;</a></h3>
<p>All messaging technologies must address routing in some way. However, DIDComm has unusual requirements:</p>
<ul>
<li>
<p>Because of security and privacy goals, DIDComm routing must impose careful limits on how and to what degree intermediate nodes are trusted.</p>
</li>
<li>
<p>Because DIDComm aims to be transport-independent, its routing model must be carefully decoupled from  strong assumptions about networking. In particular, DIDComm routing cannot make broad-brush assumptions that:</p>
</li>
<li>A given route will use only a single transport.</li>
<li>Transport mechanisms will provide any security benefits.</li>
<li>The identity and connectivity for every hop in a route will be known by any party at the time a message is sent.</li>
<li>The route from sender to recipient will be similar in hop identity, hop count, or transport mix to a complementary route from recipient back to sender.</li>
<li>
<p>All the nodes in a route are ever online at the same time.</p>
</li>
<li>
<p>Because of decentralization and multiple-peer-friendly goals, DIDComm routing cannot orient itself around servers or simple request&mdash;response patterns as mandatory components.</p>
</li>
<li>
<p>Because of privacy goals, DIDComm must offer fine distinctions in how repudiation and authentication are handled.</p>
</li>
</ul>
<p>These requirements are very demanding. They do NOT necessarily make DIDComm hard to implement. They do NOT prevent DIDComm from using common web infrastructure &mdash; indeed, DIDComm routes quite simply and elegantly over HTTP. However, they DO force the routing model to be described in a very generic, flexible way, and they DO mean that existing routing solutions are an imperfect fit. DIDComm learns as much as it can, and borrows as much as it can, from clever and battle-tested routing work done in other contexts, but it does have some unique twists.</p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>Let's focus on a simple case where <code>A</code> wants to send a message to <code>B</code>, and the route involves one intermediate hop at <code>C</code>. Suppressing a few details, DIDComm routing works like this:</p>
<ol>
<li><code>A</code> prepares a plaintext message of any type, <code>M[0]</code>, and encrypts it for the recipient, <code>B</code>. This produces <code>M[1]</code>.</li>
<li>A prepares another plaintext message of type <code>forward</code>, and adds <code>M[1]</code> to it as an attachment. This new message, <code>M[2]</code>, asks <code>C</code> to to deliver the attached payload to <code>B</code>. <code>A</code> encrypts <code>M[2]</code> for <code>C</code>, producing <code>M[3]</code>.</li>
<li><code>A</code> hands <code>M[3]</code> to <code>C</code>.</li>
<li><code>C</code> decrypts <code>M[3]</code>, producing <code>M[2]</code>. Reading the plaintext, <code>C</code> sees that it's been asked to deliver the encrypted attachment to <code>B</code>.</li>
<li><code>C</code> hands the attachment from <code>M[2]</code> &mdash; which is the encrypted message <code>M[1]</code> &mdash; to <code>B</code>.</li>
<li><code>B</code> decrypts <code>M[1]</code>, reproducing the plaintext <code>M[0]</code>.</li>
</ol>
<p><img alt="diagram of simple routing scenario" src="../collateral/simple-routing-scenario.png" /></p>
<p>This is not the simplest possible scenario; DIDComm could be direct from <code>A</code> to <code>C</code>, which would eliminate steps 2-5. Some DIDComm+HTTP interactions are that simple. And it is not the most complex DIDComm routing scenario, either. Much more elaborate routes could be described by introducing additional hops with additional <code>forward</code> messages. However, the above sequence is a good rough model to carry through the discussion that follows.</p>
<h3 id="the-forward-message">The <code>forward</code> message<a class="headerlink" href="#the-forward-message" title="Permanent link">&para;</a></h3>
<p>The <code>forward</code> message created in step 2 in our overview is a DIDComm <strong>application-level protocol</strong> message. Routing, as described here, is just one of many protocols that can be built atop DIDComm primitives. A and C are "speaking" this protocol when they communicate. The routing protocol can use the same features as any other application-level protocol; this includes <a href="https://github.com/hyperledger/aries-rfcs/blob/master/concepts/0017-attachments/README.md">attachments</a>, <a href="https://github.com/hyperledger/aries-rfcs/blob/master/concepts/0008-message-id-and-threading/README.md">message threading</a>, <a href="https://github.com/hyperledger/aries-rfcs/blob/master/features/0032-message-timing/README.md">message timing</a>, <a href="https://github.com/hyperledger/aries-rfcs/blob/master/features/0034-message-tracing/README.md">message tracing</a>, <a href="https://github.com/hyperledger/aries-rfcs/blob/master/features/0015-acks/README.md">ACKs</a>, <a href="https://github.com/hyperledger/aries-rfcs/blob/master/features/0035-report-problem/README.md">problem reports</a>, and so forth. However, before we describe the structure and semantics of the <code>forward</code> message in detail, it's important to understand some additional routing concepts.</p>
<h3 id="two-dimensions">Two Dimensions<a class="headerlink" href="#two-dimensions" title="Permanent link">&para;</a></h3>
<p>Two dimensions of routing are relevant to DIDComm. Sometimes they are confused or conflated:</p>
<ul>
<li><strong>Network routing</strong> deals with how packets flow across a digital landscape. This is the "routing" familiar to most technical people, and the one that will inform most assumptions they bring to the routing topic when reading the DIDComm spec for the first time.</li>
<li><strong>Cryptographic routing</strong> concerns itself with how packaging hides or reveals plaintext to participants in a delivery chain. In other words, it's about the routing of secrets rather than the routing of packets.</li>
</ul>
<p>The overview immediately above collapsed these two dimensions, assuming that a node relaying data is also a node decrypting. This makes for simple explanations, but it's not always a true or helpful assumption. The correspondence between these two routing dimensions can be non-trivial; a route may have ten network hops but only three cryptographic hops, and a single network hop may decrypt twice as it passes data between distinct software entities. However, simple principles explain the dynamics for each situation.</p>
<h3 id="mediators-and-relays">Mediators and Relays<a class="headerlink" href="#mediators-and-relays" title="Permanent link">&para;</a></h3>
<p>DIDComm routing uses two important constructs to model all varieties of network and cryptographic routing: <em>mediators</em> and <em>relays</em>.</p>
<p>A <strong>mediator</strong> is a participant in routing that must be accounted for by the sender's cryptography. In other words, it is visible in the cryptographic routing dimension. It has its own keys and will deliver messages only after decrypting an outer envelope to reveal a <code>forward</code> request. It must understand DIDComm routing to do this. Many types of mediators may exist, but two important ones should be widely understood, as they commonly manifest in DID Docs:</p>
<ol>
<li>A service that receives messages for many agents at a single endpoint to provide herd privacy (sometimes called an "agency") is a <em>mediator</em>.</li>
<li>A cloud-based agent that forwards messages to mobile devices is a <em>mediator</em>.</li>
</ol>
<p>In contrast, a <strong>relay</strong> is an entity that passes along encrypted messages without understanding or decrypting them. It's focused on network routing only.</p>
<p>Like mediators, relays can be used to change the transport for a message (e.g., accept an HTTP POST, then turn around and emit an email; accept a Bluetooth transmission, then turn around and emit something in a message queue). But unlike mediators, relays can do this without understanding DIDComm. Load balancers and mix networks like TOR are important types of relay.</p>
<p>Let's define mediators and relays by exploring how they manifest in a series of communication scenarios between Alice and Bob.</p>
<h4 id="scenario-1-direct">Scenario 1: direct<a class="headerlink" href="#scenario-1-direct" title="Permanent link">&para;</a></h4>
<p>Alice and Bob are both employees of a large corporation. They work in the same office, but have never met. The office has a rule that all messages between employees must be encrypted. They use paper messages and physical delivery as the transport. Alice writes a note, encrypts it so only Bob can read it, puts it in an envelope addressed to Bob, and drops the envelope on a desk that she has been told belongs to Bob. This desk is in fact Bob's, and he later picks up the message, decrypts it, and reads it.</p>
<p><img alt="routing scenario 1: direct" src="../collateral/routing-scenario-1.png" /></p>
<p>In this scenario, there is no mediator, and no relay.</p>
<h4 id="scenario-2-a-gatekeeper">Scenario 2: a gatekeeper<a class="headerlink" href="#scenario-2-a-gatekeeper" title="Permanent link">&para;</a></h4>
<p>Imagine that Bob hires an executive assistant, Carl, to filter his mail. Bob won't open any mail unless Carl looks at it and decides that it's worthy of Bob's attention.</p>
<p>Alice has to change her behavior. She continues to package a message for Bob, but now she must account for Carl as well. She take the envelope for Bob, and places it inside a new envelope addressed to Carl. Inside the outer envelope, and next to the envelope destined for Bob, Alice writes Carl an encrypted note: "This inner envelope is for Bob. Please forward."</p>
<p><img alt="routing scenario 2: mediator" src="../collateral/routing-scenario-2.png" /></p>
<p>Here, Carl is acting as a <strong>mediator</strong>. He is mostly just passing messages along. But because he is processing a message himself, and because Carl is interposed between Alice and Bob, he affects the behavior of the sender. He is a known entity in the route.</p>
<p>You may recognize this as similar to our overview example with A, B, and C. A and B correspond to Alice and Bob; C is Carl, the mediator.</p>
<h4 id="scenario-3-transparent-indirection">Scenario 3: transparent indirection<a class="headerlink" href="#scenario-3-transparent-indirection" title="Permanent link">&para;</a></h4>
<p>All is the same as the base scenario (Carl has been fired, and is thus out of the picture), except that Bob is working from home when Alice's message lands on his desk. Bob has previously arranged with his friend Darla, who lives near him, to pick up any mail that's on his desk and drop it off at his house at the end of the work day. Darla sees Alice's note and takes it home to Bob.</p>
<p><img alt="routing scenario 3: relay" src="../collateral/routing-scenario-3.png" /></p>
<p>In this scenario, Darla is acting as a <strong>relay</strong>. Note that Bob arranges for Darla to do this <em>without notifying Alice</em>, and that <em>Alice does not need to adjust her behavior in any way for the relay to work</em>.</p>
<h4 id="scenario-4-more-indirection">Scenario 4: more indirection<a class="headerlink" href="#scenario-4-more-indirection" title="Permanent link">&para;</a></h4>
<p>Like scenario 3, Darla brings Bob his mail at home. However, Bob isn't at home when his mail arrives. He's had to rush out on an errand, but he's left instructions with his son, Emil, to open any work mail, take a photo of the letter, and text him the photo. Emil intends to do this, but the camera on his phone misfires, so he convinces his sister, Francis, to take the picture on her phone and email it to him. Then he texts the photo to Bob, as arranged.</p>
<p><img alt="routing scenario 4: many relays" src="../collateral/routing-scenario-4.png" /></p>
<p>Here, Emil and Francis are also acting as relays. Note that <em>nobody knows about the full route</em>. Alice thinks she's delivering directly to Bob. So does Darla. Bob knows about Darla and Emil, but not about Francis.</p>
<p>Note, too, how the transport is changing from physical mail to email to text.</p>
<p>To the party immediately upstream (closer to the sender), a relay is indistinguishable from the next party downstream (closer to the recipient). A party anywhere in the chain can insert one or more relays upstream from themselves, as long as those relays are not upstream of another named party (sender or mediator).</p>
<h5 id="more-scenarios">More Scenarios<a class="headerlink" href="#more-scenarios" title="Permanent link">&para;</a></h5>
<p>Mediators and relays can be combined in any order and any amount in variations on our fictional scenario. Bob could employ Carl as a mediator, and Carl could work from home and arrange delivery via George, then have his daughter Hannah run messages back to Bob's desk at work. Carl could hire his own mediator. Darla could arrange for Ivan to substitute for her when she goes on vacation. And so forth.</p>
<h3 id="more-traditional-usage">More Traditional Usage<a class="headerlink" href="#more-traditional-usage" title="Permanent link">&para;</a></h3>
<p>The scenarios used above are somewhat artificial. Our most familiar routing scenarios involve edge agents running on mobile devices and accessible through bluetooth or push notification, and cloud agents that use electronic protocols as their transport. Let's see how relays and mediators apply there.</p>
<h4 id="scenario-5-direct">Scenario 5: direct<a class="headerlink" href="#scenario-5-direct" title="Permanent link">&para;</a></h4>
<p>Alice's cloud wants to talk to Bob's cloud. Bob's cloud is listening at http://bob.com/api. Alice encrypts a message for Bob and posts it to that URL.</p>
<p><img alt="scenario 5: cloud to cloud" src="../collateral/routing-scenario-5.png" /></p>
<p>In this scenario, we are using a direct transport with neither a mediator nor a relay. This is how Alice and Bob operate in Scenario 1, and it's also equivalent to our Overview minus steps 2-5.</p>
<p>When DIDComm involves only two parties, and when HTTP is convenient for both of them, this sort of direct delivery may be used. (Note that if you need n-wise, or if you need a reciprocal return route but Alice's cloud exposes no public API, this delivery scenario can present problems. More on this later.)</p>
<p>Virtually the same diagram could be used for a Bluetooth or NFC or sneakernet conversation that happens offline:</p>
<p><img alt="scenario 5b: Bluetooth or offline" src="../collateral/routing-scenario-5b.png" /></p>
<h4 id="scenario-6-herd-hosting">Scenario 6: herd hosting<a class="headerlink" href="#scenario-6-herd-hosting" title="Permanent link">&para;</a></h4>
<p>Let's tweak Scenario 5 slightly by saying that Bob's agent is one of thousands that are hosted at the same URL. Maybe the URL is now http://agents-r-us.com/inbox. Now if Alice wants to talk to Bob's cloud agent, she has to cope with a mediator. She wraps the encrypted message for Bob's cloud agent inside a <code>forward</code> message that's addressed to and encrypted for the agent of agents-r-us that functions as a gatekeeper.</p>
<p><img alt="scenario 6: herd hosting" src="../collateral/routing-scenario-6.png" /></p>
<p>This scenario is one that highlights an <strong>external mediator</strong>--so-called because the mediator lives outside the sovereign domain of the final recipient.</p>
<h4 id="scenario-7-intra-domain-dispatch">Scenario 7: intra-domain dispatch<a class="headerlink" href="#scenario-7-intra-domain-dispatch" title="Permanent link">&para;</a></h4>
<p>Now let's subtract agents-r-us. We're back to Bob's cloud agent listening directly at http://bob.com/agent. However, let's say that Alice has a different goal--now she wants to talk to the edge agent running on Bob's mobile device. This agent doesn't have a permanent IP address, so Bob uses his own cloud agent as a mediator. He tells Alice that his mobile device agent can only be reached via his cloud agent.</p>
<p><img alt="routing scenario 7: intra-domain dispatch" src="../collateral/routing-scenario-7.png" /></p>
<p>Once again, this causes Alice to modify her behavior. Again, she wraps her encrypted message. The inner message is enclosed in an outer envelope, and the outer envelope is passed to the mediator.</p>
<p>This scenario highlights an <strong>internal mediator</strong>. Internal and external mediators introduce similar features and similar constraints; the relevant difference is that internal mediators live within the sovereign domain of the recipient, and may thus be worthy of greater trust.</p>
<h4 id="scenario-8-double-mediation">Scenario 8: double mediation<a class="headerlink" href="#scenario-8-double-mediation" title="Permanent link">&para;</a></h4>
<p>Now let's combine. Bob's cloud agent is hosted at agents-r-us, AND Alice wants to reach Bob's mobile:</p>
<p><img alt="routing scenario 8: double mediation" src="../collateral/routing-scenario-8.png" /></p>
<p>This is a common pattern with HTTP-based cloud agents plus mobile edge agents, which is the most common deployment pattern we expect for many users of self-sovereign identity. Note that the properties of the agency and the routing agent are not particularly special--they are just an external and an internal mediator, respectively.</p>
<h3 id="remember-routes-are-one-way-not-duplex">Remember Routes are One-Way (not Duplex)<a class="headerlink" href="#remember-routes-are-one-way-not-duplex" title="Permanent link">&para;</a></h3>
<p>In all of this discussion, note that we are analyzing <em>only</em> a flow from Alice to Bob. How Bob gets a message back to Alice is a completely separate question. Just because Carl, Darla, Emil, Francis, and Agents-R-Us may be involved in how messages flow from Alice to Bob, does not mean they are involved in flow the opposite direction.</p>
<p>Note how this breaks the simple assumptions of pure request-response technologies like HTTP, that assume the channel in (request) is also the channel out (response). <a href="https://en.wikipedia.org/wiki/Duplex_%28telecommunications%29">Duplex</a> request-response can be modeled with DIDComm, but doing so requires support that may not always be available, plus cooperative behavior governed by the <a href="https://github.com/hyperledger/aries-rfcs/blob/master/features/0008-message-id-and-threading/README.md"><code>~thread</code></a> decorator.</p>
<h3 id="routing-protocol">Routing Protocol<a class="headerlink" href="#routing-protocol" title="Permanent link">&para;</a></h3>
<p>Now that we understand mediators and relays, how and why they might be combined in various ways, and how their presence influences delivery semantics, we can describe the actual application-level routing protocol that any DIDComm sender speaks with a destward mediator. See [Routing Protocol] in the spec.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes"], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>